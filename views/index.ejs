<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <style>
      /* Previous styles remain the same */
      table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid #ccc;
        margin-top: 20px;
        margin-bottom: 40px;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: right;
      }

      th {
        background-color: #f4f4f4;
        text-align: center;
      }

      td:first-child {
        text-align: left;
      }

      caption {
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.2em;
      }

      /* Enhanced styles for file blocks */
      .uploaded-files {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .uploaded-files h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
      }

      .file-blocks-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .file-item {
        display: inline-block;
        padding: 12px 20px;
        background-color: white;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .file-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }

      .file-item.selected {
        background-color: #90EE90;
        border-color: #4CAF50;
        color: #2E7D32;
        font-weight: bold;
      }

      .export-button {
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .export-button:hover:not(:disabled) {
        background-color: #0056b3;
        transform: translateY(-2px);
      }

      .export-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .selection-info {
        margin-top: 10px;
        color: #666;
        font-size: 0.9em;
      }
    </style>
    <script>
      let tableData = window.initialTableData || []; // Initialize with session data if available
      const selected_indices = [103, 99, 177, 158, "", "", 114, 182, 193, 79, 148, 174];
      let selectedFiles = new Set();

      function processFileData(content) {
        try {
          const allValues = content
            .split(/\n/)
            .map(line => line.split(';'))
            .flat()
            .filter(item => item.trim() !== '');

          return allValues
            .map(value => {
              const number = Number(parseFloat(value).toFixed(2));
              return !isNaN(number) ? Math.abs(number) : null;
            })
            .filter(value => value !== null);
        } catch (error) {
          console.error('Error processing file data:', error);
          return [];
        }
      }

      function updateUploadedFiles() {
        const uploadedFilesContainer = document.getElementById("uploaded-files");
        uploadedFilesContainer.innerHTML = '<h3>Uploaded Files:</h3>';
        
        tableData.forEach(({ fileName }) => {
          const fileItem = document.createElement("div");
          fileItem.className = `file-item ${selectedFiles.has(fileName) ? 'selected' : ''}`;
          fileItem.textContent = fileName;
          fileItem.onclick = () => toggleFileSelection(fileName);
          uploadedFilesContainer.appendChild(fileItem);
        });

        // Update export button state
        const exportButton = document.getElementById("export-button");
        exportButton.disabled = selectedFiles.size === 0;
      }

      function toggleFileSelection(fileName) {
        if (selectedFiles.has(fileName)) {
          selectedFiles.delete(fileName);
        } else {
          selectedFiles.add(fileName);
        }
        updateUploadedFiles();
      }

      function createTable(fileName, numericalData) {
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `File: ${fileName}`;
        table.appendChild(caption);

        // Header row
        const headerRow = document.createElement("tr");
        headerRow.appendChild(createCell("File", "th"));
        numericalData.forEach((_, index) => {
          headerRow.appendChild(createCell(index + 1, "th"));
        });
        table.appendChild(headerRow);

        // Data row
        const valuesRow = document.createElement("tr");
        valuesRow.appendChild(createCell(fileName, "td"));
        numericalData.forEach((value) => {
          valuesRow.appendChild(createCell(value.toFixed(2), "td"));
        });
        table.appendChild(valuesRow);

        return table;
      }

      function createCell(content, type) {
        const cell = document.createElement(type);
        cell.textContent = content;
        return cell;
      }

      async function saveToSession(data) {
        try {
          const response = await fetch('/save-table-data', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tableData: data })
          });

          if (!response.ok) {
            throw new Error('Failed to save data');
          }
        } catch (error) {
          console.error('Error saving to session:', error);
          alert('Failed to save data to session');
        }
      }

      async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = "";
        tableData = [];
        selectedFiles.clear();

        try {
          // Sort files by numeric value in filename
          const sortedFiles = files.sort((a, b) => {
            const getNumber = (filename) => {
              const match = filename.match(/\d+/);
              return match ? parseInt(match[0]) : 0;
            };
            return getNumber(a.name) - getNumber(b.name);
          });

          const fileContents = await Promise.all(
            sortedFiles.map(file => 
              new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve({
                  fileName: file.name.replace(".txt", ""),
                  content: e.target.result
                });
                reader.onerror = reject;
                reader.readAsText(file);
              })
            )
          );

          fileContents.forEach(({ fileName, content }) => {
            const numericalData = processFileData(content);
            tableData.push({ fileName, values: numericalData });
            resultsContainer.appendChild(createTable(fileName, numericalData));
          });

          await saveToSession(tableData);
          updateUploadedFiles();
        } catch (error) {
          console.error('Error handling files:', error);
          // alert('Error processing files. Please try again.');
        }
      }

      async function exportData() {
        try {
          const filteredData = tableData
            .filter(({ fileName }) => selectedFiles.has(fileName))
            .map(({ fileName, values }) => ({
              fileName,
              filteredValues: selected_indices.map(index => {
                const arrayIndex = index !== "" ? parseInt(index) - 1 : -1;
                return arrayIndex >= 0 && arrayIndex < values.length ? values[arrayIndex] : "";
              })
          }));

          const response = await fetch("/export", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              exportData: filteredData,
              tableData: JSON.stringify(tableData)
            })
          });

          if (!response.ok) {
            throw new Error('Export failed');
          }

          window.location.href = "/export";
        } catch (error) {
          console.error("Export error:", error);
          alert("Failed to export data. Please try again.");
        }
      }

      // Initialize data from session
      document.addEventListener('DOMContentLoaded', () => {
        const resultsContainer = document.getElementById("results-container");
        if (tableData.length > 0) {
          tableData.forEach(({ fileName, values }) => {
            resultsContainer.appendChild(createTable(fileName, values));
          });
          updateUploadedFiles();
        }
      });
    </script>
  </head>
  <body>
    <h1><%= title %></h1>
    <p>Welcome to <%= title %></p>

    <div>
      <label for="file-upload">Upload .txt files:</label>
      <input type="file" id="file-upload" accept=".txt" multiple onchange="handleFileUpload(event)" />
    </div>

    <div class="uploaded-files" id="uploaded-files">
      <h3>Uploaded Files:</h3>
    </div>


    <div style="margin-top: 20px;">
      <button onclick="exportData()">Export</button>
    </div>

    <div id="results-container"></div>
  </body>
</html>