<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid #ccc;
        margin-top: 20px;
        margin-bottom: 40px;
      }

      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: right;
      }

      th {
        background-color: #f4f4f4;
        text-align: center;
      }

      td:first-child {
        text-align: left;
      }

      caption {
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.2em;
      }
    </style>
    <script>
      let tableData = window.initialTableData || []; // Initialize with session data if available
      const selected_indices = [103, 99, 177, 158, "", "", 114, 182, 193, 79, 148, 174];

      function processFileData(content) {
        try {
          const allValues = content
            .split(/\n/)
            .map(line => line.split(';'))
            .flat()
            .filter(item => item.trim() !== '');

          return allValues
            .map(value => {
              const number = Number(parseFloat(value).toFixed(2));
              return !isNaN(number) ? Math.abs(number) : null;
            })
            .filter(value => value !== null);
        } catch (error) {
          console.error('Error processing file data:', error);
          return [];
        }
      }

      function createTable(fileName, numericalData) {
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `File: ${fileName}`;
        table.appendChild(caption);

        // Header row
        const headerRow = document.createElement("tr");
        headerRow.appendChild(createCell("File", "th"));
        numericalData.forEach((_, index) => {
          headerRow.appendChild(createCell(index + 1, "th"));
        });
        table.appendChild(headerRow);

        // Data row
        const valuesRow = document.createElement("tr");
        valuesRow.appendChild(createCell(fileName, "td"));
        numericalData.forEach((value) => {
          valuesRow.appendChild(createCell(value.toFixed(2), "td"));
        });
        table.appendChild(valuesRow);

        return table;
      }

      function createCell(content, type) {
        const cell = document.createElement(type);
        cell.textContent = content;
        return cell;
      }

      async function saveToSession(data) {
        try {
          const response = await fetch('/save-table-data', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tableData: data })
          });

          if (!response.ok) {
            throw new Error('Failed to save data');
          }
        } catch (error) {
          console.error('Error saving to session:', error);
          alert('Failed to save data to session');
        }
      }

      async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = "";
        tableData = [];

        try {
          // Sort files by numeric value in filename
          const sortedFiles = files.sort((a, b) => {
            const getNumber = (filename) => {
              const match = filename.match(/\d+/);
              return match ? parseInt(match[0]) : 0;
            };
            return getNumber(a.name) - getNumber(b.name);
          });

          const fileContents = await Promise.all(
            sortedFiles.map(file => 
              new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve({
                  fileName: file.name.replace(".txt", ""),
                  content: e.target.result
                });
                reader.onerror = reject;
                reader.readAsText(file);
              })
            )
          );

          fileContents.forEach(({ fileName, content }) => {
            const numericalData = processFileData(content);
            tableData.push({ fileName, values: numericalData });
            resultsContainer.appendChild(createTable(fileName, numericalData));
          });

          await saveToSession(tableData);
        } catch (error) {
          console.error('Error handling files:', error);
          alert('Error processing files. Please try again.');
        }
      }

      async function exportData() {
        try {
          const filteredData = tableData.map(({ fileName, values }) => ({
            fileName,
            filteredValues: selected_indices.map(index => {
              const arrayIndex = index !== "" ? parseInt(index) - 1 : -1;
              return arrayIndex >= 0 && arrayIndex < values.length ? values[arrayIndex] : "";
            })
          }));

          const response = await fetch("/export", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              exportData: filteredData,
              tableData: JSON.stringify(tableData)
            })
          });

          if (!response.ok) {
            throw new Error('Export failed');
          }

          window.location.href = "/export";
        } catch (error) {
          console.error("Export error:", error);
          alert("Failed to export data. Please try again.");
        }
      }

      function goToInspectionSheet() {
        window.location.href = "/inspection-sheet";
      }

      // Initialize data from session
      document.addEventListener('DOMContentLoaded', () => {
        const resultsContainer = document.getElementById("results-container");
        if (tableData.length > 0) {
          tableData.forEach(({ fileName, values }) => {
            resultsContainer.appendChild(createTable(fileName, values));
          });
        }
      });
    </script>
  </head>
  <body>
    <h1><%= title %></h1>
    <p>Welcome to <%= title %></p>

    <div>
      <label for="file-upload">Upload .txt files:</label>
      <input type="file" id="file-upload" accept=".txt" multiple onchange="handleFileUpload(event)" />
    </div>

    <div style="margin-top: 20px;">
      <button onclick="exportData()">Export</button>
      <button onclick="goToInspectionSheet()">Go to Inspection Sheet</button>
    </div>

    <div id="results-container"></div>
  </body>
</html>